<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join Organization | NOVA</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; padding: 40px; background: #f5f5f5; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        h2 { color: #333; margin-top: 0; }
        .info-box { background: #e85a2a10; padding: 15px; border-radius: 8px; border-left: 4px solid #e85a2a; margin-bottom: 20px; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #e85a2a; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        button:disabled { background: #ccc; }
        .error { color: red; font-size: 14px; margin-bottom: 10px; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="card">
    <div id="loader">Loading invitation details...</div>
    
    <div id="form-container" class="hidden">
        <h2 id="title">Accept Invitation</h2>
        <div class="info-box">
            You've been invited to join <strong id="org-name">...</strong>
        </div>

        <div id="error-msg" class="error"></div>

        <input type="text" id="full-name" placeholder="Full Name">
        <input type="email" id="email" disabled> <input type="password" id="password" placeholder="Create Password (min 6 chars)">
        <input type="password" id="confirm-password" placeholder="Confirm Password">
        
        <button id="submit-btn">Complete Registration</button>
    </div>

    <div id="success-container" class="hidden">
        <h2>ðŸŽ‰ Success!</h2>
        <p>Your account has been created and linked to your organization.</p>
        <p>You can now open the <strong>NOVA App</strong> on your phone and sign in.</p>
    </div>
</div>

<script>
   // 1. Setup Supabase
const SUPABASE_URL = 'https://xgjeyphgmekakpvttjhr.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // Use your key
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// 2. Get the token from the URL
const urlParams = new URLSearchParams(window.location.search);
const inviteToken = urlParams.get('token');

const formContainer = document.getElementById('form-container');
const loader = document.getElementById('loader');

// 3. Fetch Invite Details on Load
async function loadInvite() {
    if (!inviteToken) {
        loader.innerHTML = "âŒ No invite token found.";
        return;
    }

    try {
        const { data: invite, error: inviteError } = await supabaseClient
            .from('user_invites')
            .select('email, organization_id')
            .eq('invite_token', inviteToken)
            .eq('status', 'pending')
            .maybeSingle();

        if (inviteError || !invite) {
            loader.innerHTML = "âŒ This invite is invalid or has expired.";
            return;
        }

        const { data: org } = await supabaseClient
            .from('organizations')
            .select('name')
            .eq('id', invite.organization_id)
            .maybeSingle();

        loader.classList.add('hidden');
        formContainer.classList.remove('hidden');
        document.getElementById('org-name').innerText = org ? org.name : "Your Team";
        document.getElementById('email').value = invite.email;

    } catch (err) {
        loader.innerHTML = "âŒ An unexpected error occurred.";
    }
}

// 4. Handle Registration
document.getElementById('submit-btn').addEventListener('click', async () => {
    const fullName = document.getElementById('full-name').value;
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const confirm = document.getElementById('confirm-password').value;
    const btn = document.getElementById('submit-btn');
    const errorMsg = document.getElementById('error-msg');

    // Basic Validation
    if (!fullName || password.length < 6) {
        errorMsg.innerText = "Please fill all fields. Password must be 6+ chars.";
        return;
    }
    if (password !== confirm) {
        errorMsg.innerText = "Passwords do not match.";
        return;
    }

    // UI Feedback
    btn.disabled = true;
    btn.innerText = "Processing...";
    errorMsg.innerText = "";

    try {
        // STEP 1: Create the Auth User
        const { data: authData, error: authError } = await supabaseClient.auth.signUp({
            email,
            password,
            options: { data: { full_name: fullName } }
        });

        if (authError) throw authError;

        if (authData?.user) {
            console.log("Auth success, linking organization...");
            
            // STEP 2: Call the RPC to link org, roles, and profile
            // Use the "accept_invite" function we updated in the SQL editor earlier
            const { data: rpcData, error: rpcError } = await supabaseClient.rpc('accept_invite', {
                p_token: inviteToken, // Fixed variable name
                p_user_id: authData.user.id 
            });

            if (rpcError) {
                console.error("RPC Error:", rpcError);
                // We don't throw here because account is created, but we warn the user
                alert("Account created, but we couldn't link your roles automatically. Please contact your admin.");
            }
        }

        // STEP 3: Show Success
        formContainer.classList.add('hidden');
        document.getElementById('success-container').classList.remove('hidden');

    } catch (err) {
        console.error("Signup failed:", err);
        errorMsg.innerText = err.message;
        btn.disabled = false;
        btn.innerText = "Complete Registration";
    }
});

loadInvite();
</script>

</body>
</html>
